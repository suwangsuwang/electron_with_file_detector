<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ä»¶ç±»å‹æ£€æµ‹ï¼ˆSwiftï¼‰</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 24px; }
    .row { margin-bottom: 12px; }
    .btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
    .log { background: #111; color: #0f0; padding: 12px; height: 180px; overflow: auto; border-radius: 6px; }
    .result { padding: 12px; border: 1px solid #eee; border-radius: 6px; }

    /* æ‹–æ‹½æ’åºåˆ—è¡¨æ ·å¼ */
    .drag-list-container {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .drag-list-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #495057;
    }

    .drag-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .drag-item {
      padding: 12px 16px;
      margin: 8px 0;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      cursor: grab;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .drag-item:hover {
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
    }

    .drag-item.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
      cursor: grabbing;
      border-color: #007bff;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .drag-item.drag-over {
      border-color: #28a745;
      background: #f8fff9;
    }

    .drag-handle {
      width: 20px;
      height: 20px;
      background: #6c757d;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .drag-content {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .drag-icon {
      font-size: 20px;
      margin-right: 12px;
    }

    .drag-text {
      font-size: 14px;
      color: #495057;
    }

    .drag-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 4px 8px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      background: #f8f9fa;
      border-color: #adb5bd;
    }

    .add-item-form {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .form-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .form-input {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      flex: 1;
    }

    .form-btn {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .form-btn:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>æ–‡ä»¶ç±»å‹æ£€æµ‹ï¼ˆSwift å…¨å±€ç›‘å¬ï¼‰</h2>
  <div class="row">
    <button id="start" class="btn">å¯åŠ¨æ£€æµ‹</button>
    <button id="stop" class="btn">åœæ­¢æ£€æµ‹</button>
    <button id="openTestPage" class="btn" style="background: #28a745; color: white;">ğŸ§ª æ‰“å¼€æ‹–æ‹½æµ‹è¯•é¡µé¢</button>
  </div>
  <div class="row result" id="result">ç­‰å¾…æ–‡ä»¶æ‹–æ‹½å¹¶é‡Šæ”¾â€¦</div>

  <!-- æ‹–æ‹½æ’åºåˆ—è¡¨è§†å›¾ -->
  <div class="drag-list-container">
    <div class="drag-list-title">ğŸ§© æ‹–æ‹½æ’åºæµ‹è¯•åˆ—è¡¨</div>
    <p style="margin-bottom: 15px; color: #6c757d; font-size: 14px;">
      è¿™æ˜¯ä¸€ä¸ªæ‹–æ‹½æ’åºåˆ—è¡¨ï¼Œç”¨äºæµ‹è¯•é€æ˜è§†å›¾å±•å¼€é€»è¾‘æ˜¯å¦ä¼šå½±å“å…¶ä»–åº”ç”¨çš„æ‹–æ‹½åŠŸèƒ½ã€‚
      ä½ å¯ä»¥æ‹–æ‹½åˆ—è¡¨é¡¹æ¥é‡æ–°æ’åºï¼Œæˆ–è€…æ·»åŠ æ–°çš„é¡¹ç›®ã€‚
    </p>

    <ul class="drag-list" id="dragList">
      <li class="drag-item" draggable="true" data-id="1">
        <div class="drag-content">
          <div class="drag-handle"></div>
          <div class="drag-icon">ğŸ“</div>
          <div class="drag-text">é¡¹ç›® 1 - æ‹–æ‹½æµ‹è¯•</div>
        </div>
        <div class="drag-actions">
          <button class="action-btn" onclick="editItem(this)">ç¼–è¾‘</button>
          <button class="action-btn" onclick="deleteItem(this)">åˆ é™¤</button>
        </div>
      </li>
      <li class="drag-item" draggable="true" data-id="2">
        <div class="drag-content">
          <div class="drag-handle"></div>
          <div class="drag-icon">ğŸ“„</div>
          <div class="drag-text">é¡¹ç›® 2 - æ–‡ä»¶æ£€æµ‹</div>
        </div>
        <div class="drag-actions">
          <button class="action-btn" onclick="editItem(this)">ç¼–è¾‘</button>
          <button class="action-btn" onclick="deleteItem(this)">åˆ é™¤</button>
        </div>
      </li>
      <li class="drag-item" draggable="true" data-id="3">
        <div class="drag-content">
          <div class="drag-handle"></div>
          <div class="drag-icon">âš™ï¸</div>
          <div class="drag-text">é¡¹ç›® 3 - ç³»ç»Ÿè®¾ç½®</div>
        </div>
        <div class="drag-actions">
          <button class="action-btn" onclick="editItem(this)">ç¼–è¾‘</button>
          <button class="action-btn" onclick="deleteItem(this)">åˆ é™¤</button>
        </div>
      </li>
      <li class="drag-item" draggable="true" data-id="4">
        <div class="drag-content">
          <div class="drag-handle"></div>
          <div class="drag-icon">ğŸ¨</div>
          <div class="drag-text">é¡¹ç›® 4 - ç•Œé¢è®¾è®¡</div>
        </div>
        <div class="drag-actions">
          <button class="action-btn" onclick="editItem(this)">ç¼–è¾‘</button>
          <button class="action-btn" onclick="deleteItem(this)">åˆ é™¤</button>
        </div>
      </li>
    </ul>

    <div class="add-item-form">
      <div class="form-row">
        <input type="text" class="form-input" id="newItemText" placeholder="è¾“å…¥æ–°é¡¹ç›®åç§°...">
        <select class="form-input" id="newItemIcon" style="flex: 0 0 80px;">
          <option value="ğŸ“">ğŸ“</option>
          <option value="ğŸ“„">ğŸ“„</option>
          <option value="âš™ï¸">âš™ï¸</option>
          <option value="ğŸ¨">ğŸ¨</option>
          <option value="ğŸš€">ğŸš€</option>
          <option value="ğŸ’¡">ğŸ’¡</option>
        </select>
        <button class="form-btn" onclick="addNewItem()">æ·»åŠ é¡¹ç›®</button>
      </div>
    </div>
  </div>

  <div class="row log" id="log"></div>

  <script>
    const { ipcRenderer } = require('electron');

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const openTestPageBtn = document.getElementById('openTestPage');
    const resultDiv = document.getElementById('result');
    const logDiv = document.getElementById('log');

    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      logDiv.textContent += `[${ts}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    startBtn.onclick = async () => {
      const r = await ipcRenderer.invoke('start-file-drag-detection');
      log(`å¯åŠ¨æ£€æµ‹: ${JSON.stringify(r)}`);
    };
    stopBtn.onclick = async () => {
      const r = await ipcRenderer.invoke('stop-file-drag-detection');
      log(`åœæ­¢æ£€æµ‹: ${JSON.stringify(r)}`);
    };

    openTestPageBtn.onclick = async () => {
      try {
        const result = await ipcRenderer.invoke('open-test-page');
        if (result.success) {
          log('âœ… æ‹–æ‹½æµ‹è¯•é¡µé¢å·²æ‰“å¼€');
        } else {
          log('âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        log('âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å¤±è´¥: ' + error.message);
      }
    };

    ipcRenderer.on('file-detected', (_e, fileInfo) => {
      log(`Swift æ–‡ä»¶: ${JSON.stringify(fileInfo)}`);
      resultDiv.textContent = `${fileInfo.fileName} â€” ${fileInfo.description} (${fileInfo.fileExtension || 'æ— æ‰©å±•å'})`;
    });

    // æ‹–æ‹½æ’åºåŠŸèƒ½
    let draggedItem = null;
    let nextId = 5;

    // åˆå§‹åŒ–æ‹–æ‹½äº‹ä»¶
    function initDragAndDrop() {
      const dragList = document.getElementById('dragList');

      dragList.addEventListener('dragstart', handleDragStart);
      dragList.addEventListener('dragover', handleDragOver);
      dragList.addEventListener('drop', handleDrop);
      dragList.addEventListener('dragend', handleDragEnd);
    }

    function handleDragStart(e) {
      if (e.target.classList.contains('drag-item')) {
        draggedItem = e.target;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.outerHTML);
        log(`å¼€å§‹æ‹–æ‹½é¡¹ç›®: ${e.target.querySelector('.drag-text').textContent}`);
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      const targetItem = e.target.closest('.drag-item');
      if (targetItem && targetItem !== draggedItem) {
        // ç§»é™¤å…¶ä»–é¡¹ç›®çš„ drag-over æ ·å¼
        document.querySelectorAll('.drag-item').forEach(item => {
          if (item !== targetItem) item.classList.remove('drag-over');
        });
        targetItem.classList.add('drag-over');
      }
    }

    function handleDrop(e) {
      e.preventDefault();

      const targetItem = e.target.closest('.drag-item');
      if (targetItem && draggedItem && targetItem !== draggedItem) {
        const allItems = [...document.querySelectorAll('.drag-item')];
        const draggedIndex = allItems.indexOf(draggedItem);
        const targetIndex = allItems.indexOf(targetItem);

        if (draggedIndex < targetIndex) {
          targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
        } else {
          targetItem.parentNode.insertBefore(draggedItem, targetItem);
        }

        log(`é¡¹ç›®å·²é‡æ–°æ’åº: ${draggedItem.querySelector('.drag-text').textContent} -> ä½ç½® ${targetIndex + 1}`);
      }

      // æ¸…ç†æ ·å¼
      document.querySelectorAll('.drag-item').forEach(item => {
        item.classList.remove('drag-over');
      });
    }

    function handleDragEnd(e) {
      if (e.target.classList.contains('drag-item')) {
        e.target.classList.remove('dragging');
        draggedItem = null;
      }
    }

    // æ·»åŠ æ–°é¡¹ç›®
    function addNewItem() {
      const textInput = document.getElementById('newItemText');
      const iconSelect = document.getElementById('newItemIcon');

      if (!textInput.value.trim()) {
        alert('è¯·è¾“å…¥é¡¹ç›®åç§°');
        return;
      }

      const newItem = document.createElement('li');
      newItem.className = 'drag-item';
      newItem.draggable = true;
      newItem.setAttribute('data-id', nextId++);

      newItem.innerHTML = `
        <div class="drag-content">
          <div class="drag-handle"></div>
          <div class="drag-icon">${iconSelect.value}</div>
          <div class="drag-text">${textInput.value}</div>
        </div>
        <div class="drag-actions">
          <button class="action-btn" onclick="editItem(this)">ç¼–è¾‘</button>
          <button class="action-btn" onclick="deleteItem(this)">åˆ é™¤</button>
        </div>
      `;

      document.getElementById('dragList').appendChild(newItem);
      textInput.value = '';
      log(`æ·»åŠ æ–°é¡¹ç›®: ${textInput.value}`);
    }

    // ç¼–è¾‘é¡¹ç›®
    function editItem(btn) {
      const item = btn.closest('.drag-item');
      const textElement = item.querySelector('.drag-text');
      const currentText = textElement.textContent;

      const newText = prompt('ç¼–è¾‘é¡¹ç›®åç§°:', currentText);
      if (newText && newText.trim() && newText !== currentText) {
        textElement.textContent = newText;
        log(`ç¼–è¾‘é¡¹ç›®: ${currentText} -> ${newText}`);
      }
    }

    // åˆ é™¤é¡¹ç›®
    function deleteItem(btn) {
      const item = btn.closest('.drag-item');
      const text = item.querySelector('.drag-text').textContent;

      if (confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${text}" å—ï¼Ÿ`)) {
        item.remove();
        log(`åˆ é™¤é¡¹ç›®: ${text}`);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      initDragAndDrop();
      log('æ‹–æ‹½æ’åºåˆ—è¡¨å·²åˆå§‹åŒ–ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•æ‹–æ‹½åŠŸèƒ½');
    });
  </script>
</body>
</html>
