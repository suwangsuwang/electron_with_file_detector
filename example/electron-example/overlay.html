<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é€æ˜è¦†ç›–å±‚</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: rgba(255, 0, 0, 0.5); /* æ›´æ˜æ˜¾çš„çº¢è‰²åŠé€æ˜èƒŒæ™¯ */
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-app-region: no-drag;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 255, 0, 0.5); /* æ›´æ˜æ˜¾çš„ç»¿è‰²åŠé€æ˜èƒŒæ™¯ */
            z-index: 9999;
            pointer-events: auto;
        }

        .drag-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            z-index: 10000;
            pointer-events: none;
        }

        .drag-indicator.show {
            display: block;
        }

        .overlay-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 0, 0.9);
            color: black;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            display: none;
            z-index: 10001;
            pointer-events: none;
            border: 2px solid #ff6600;
        }

        .overlay-status.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="overlay"></div>
    <div id="dragIndicator" class="drag-indicator">
        ğŸ–±ï¸ æ­£åœ¨æ‹–æ‹½æ–‡ä»¶...
    </div>
    <div id="overlayStatus" class="overlay-status">
        ğŸŸ¢ è¦†ç›–çª—å£å·²å±•å¼€ - å¯ä»¥æ‹–æ‹½æ–‡ä»¶
    </div>

    <!-- å…¨å±€é¼ æ ‡ç›‘å¬çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="globalStatus" style="
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 255, 0, 0.8);
        color: black;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 10002;
        pointer-events: none;
    ">ğŸŒ å…¨å±€ç›‘å¬å·²å¯åŠ¨</div>

    <script>
        const { ipcRenderer } = require('electron');

        const overlay = document.getElementById('overlay');
        const dragIndicator = document.getElementById('dragIndicator');
        const overlayStatus = document.getElementById('overlayStatus');
        const globalStatus = document.getElementById('globalStatus');

        let isDragging = false;
        let dragStartTime = 0;
        let mouseDownTime = 0;
        let mouseDownPosition = { x: 0, y: 0 };
        let isWindowExpanded = false;

        // ç›‘å¬æ‹–æ‹½å¼€å§‹
        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();

            showDebugInfo('æ‹–æ‹½è¿›å…¥è¦†ç›–å±‚');

            if (!isDragging) {
                isDragging = true;
                dragStartTime = Date.now();
                dragIndicator.classList.add('show');
                showDebugInfo('å¼€å§‹æ‹–æ‹½æ–‡ä»¶');
                console.log('å¼€å§‹æ‹–æ‹½æ–‡ä»¶');
            }
        });

        // ç›‘å¬æ‹–æ‹½ç»“æŸï¼ˆä¸å†åœ¨å‰ç«¯åšç±»å‹è¯†åˆ«ï¼Œæ”¹ç”± Swift ä¾§å®Œæˆï¼‰
        document.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            showDebugInfo('æ–‡ä»¶æ‹–æ‹½é‡Šæ”¾ï¼ˆç±»å‹è¯†åˆ«ç”± Swift ä¾§å®Œæˆï¼‰');

            if (isDragging) {
                isDragging = false;
                dragIndicator.classList.remove('show');
            }

            // æ‹–æ‹½ç»“æŸåç¼©å°çª—å£
            if (isWindowExpanded) {
                try {
                    await ipcRenderer.invoke('minimize-overlay');
                    isWindowExpanded = false;
                    showDebugInfo('æ‹–æ‹½ç»“æŸï¼Œè¦†ç›–çª—å£å·²ç¼©å°');
                    console.log('æ‹–æ‹½ç»“æŸï¼Œç¼©å°è¦†ç›–çª—å£');
                } catch (error) {
                    showDebugInfo('ç¼©å°è¦†ç›–çª—å£å¤±è´¥: ' + error.message);
                    console.error('ç¼©å°è¦†ç›–çª—å£å¤±è´¥:', error);
                }
            }
        });

        // ç›‘å¬æ‹–æ‹½ç¦»å¼€
        document.addEventListener('dragleave', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            // æ£€æŸ¥æ˜¯å¦çœŸçš„ç¦»å¼€äº†çª—å£
            if (e.relatedTarget === null) {
                isDragging = false;
                dragIndicator.classList.remove('show');

                // æ‹–æ‹½ç¦»å¼€æ—¶ç¼©å°çª—å£
                if (isWindowExpanded) {
                    try {
                        await ipcRenderer.invoke('minimize-overlay');
                        isWindowExpanded = false;
                        console.log('æ‹–æ‹½ç¦»å¼€ï¼Œç¼©å°è¦†ç›–çª—å£');
                    } catch (error) {
                        console.error('ç¼©å°è¦†ç›–çª—å£å¤±è´¥:', error);
                    }
                }
            }
        });

        // ç›‘å¬æ‹–æ‹½ç§»åŠ¨
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        // æ·»åŠ ç®€å•çš„ç‚¹å‡»æµ‹è¯•
        document.addEventListener('click', (e) => {
            console.log('ğŸ¯ ç‚¹å‡»äº‹ä»¶è§¦å‘:', e.clientX, e.clientY);
            showDebugInfo(`ğŸ¯ ç‚¹å‡»äº‹ä»¶: (${e.clientX}, ${e.clientY})`);
        });

        // å…¨å±€é¼ æ ‡äº‹ä»¶ç›‘å¬ï¼ˆç•Œé¢åé¦ˆï¼‰
        document.addEventListener('mousedown', async (e) => {
            console.log('ğŸŒ å…¨å±€é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶:', e.clientX, e.clientY);
            showDebugInfo(`ğŸŒ å…¨å±€é¼ æ ‡æŒ‰ä¸‹: (${e.clientX}, ${e.clientY})`);

            if (!isOverlayExpanded) {
                try {
                    const result = await ipcRenderer.invoke('expand-overlay');
                    if (result.success) {
                        isOverlayExpanded = true;
                        overlayStatus.classList.add('show');
                        showDebugInfo('âœ… å…¨å±€é¼ æ ‡æŒ‰ä¸‹ï¼Œè¦†ç›–çª—å£å·²å±•å¼€');
                    }
                } catch (error) {
                    showDebugInfo('âŒ å±•å¼€è¦†ç›–çª—å£å¤±è´¥: ' + error.message);
                }
            }
        });

        document.addEventListener('mouseup', async (e) => {
            console.log('ğŸŒ å…¨å±€é¼ æ ‡æŠ¬èµ·äº‹ä»¶:', e.clientX, e.clientY);
            showDebugInfo(`ğŸŒ å…¨å±€é¼ æ ‡æŠ¬èµ·: (${e.clientX}, ${e.clientY})`);

            if (isOverlayExpanded) {
                try {
                    const result = await ipcRenderer.invoke('minimize-overlay');
                    if (result.success) {
                        isOverlayExpanded = false;
                        overlayStatus.classList.remove('show');
                        showDebugInfo('âœ… å…¨å±€é¼ æ ‡æŠ¬èµ·ï¼Œè¦†ç›–çª—å£å·²ç¼©å°');
                    }
                } catch (error) {
                    showDebugInfo('âŒ ç¼©å°è¦†ç›–çª—å£å¤±è´¥: ' + error.message);
                }
            }
        });

        // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼ˆESCé”®å…³é—­è¦†ç›–å±‚ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                ipcRenderer.invoke('close-overlay');
            }
        });

        console.log('é€æ˜è¦†ç›–å±‚å·²åŠ è½½ï¼Œç­‰å¾…æ‹–æ‹½äº‹ä»¶...');
        console.log('ğŸ–±ï¸ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        console.log('ğŸ“‹ è¦†ç›–çª—å£çŠ¶æ€æŒ‡ç¤ºå™¨å·²å‡†å¤‡å°±ç»ª');

        // é€šçŸ¥ä¸»è¿›ç¨‹è¦†ç›–å±‚å·²åŠ è½½
        ipcRenderer.invoke('overlay-loaded').then(() => {
            console.log('å·²é€šçŸ¥ä¸»è¿›ç¨‹è¦†ç›–å±‚åŠ è½½å®Œæˆ');
        }).catch(error => {
            console.error('é€šçŸ¥ä¸»è¿›ç¨‹å¤±è´¥:', error);
        });

        // æ·»åŠ é¡µé¢åŠ è½½å®Œæˆçš„è°ƒè¯•ä¿¡æ¯
        showDebugInfo('ğŸ¯ è¦†ç›–å±‚å·²åŠ è½½ï¼Œç­‰å¾…é¼ æ ‡äº‹ä»¶...');

        function showDebugInfo(message) {
            console.log('[DEBUG]', message);
            const debugDiv = document.createElement('div');
            debugDiv.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 10001;
                max-width: 300px;
                word-wrap: break-word;
            `;
            debugDiv.textContent = message;
            document.body.appendChild(debugDiv);
            setTimeout(() => {
                if (debugDiv.parentNode) {
                    debugDiv.parentNode.removeChild(debugDiv);
                }
            }, 3000);
        }
    </script>
</body>
</html>
